---
title: "hooded_sprayer"
author: "Maxwel Coura Oliveira"
date: "3/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message = FALSE}
library(tidyverse)
library(drc)
library(tidymodels)
library(lmerTest)
options(scipen = 999)
```

# Deposition --------------------------------------------------------------------------------

```{r missouri-data}
path_mo <- "./data/deposition/Deposition data_MO.xlsx"

missouri <- path_mo %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_mo", "upwind_mo", "inswath_mo")) %>% 
  map(readxl::read_excel, path = path_mo)



downwind_mo <- missouri$downwind_mo %>% 
  mutate(type = "downwind")
upwind_mo <- missouri$upwind_mo %>% 
  mutate('distance (m)' = NA,
         type = "upwind")
inswath_mo <- missouri$inswath_mo %>%
  mutate('distance (m)' = NA,
         type = "inswath") %>% 
  dplyr::select(-...8)

missouri <- downwind_mo %>% 
  bind_rows(upwind_mo) %>% 
  bind_rows(inswath_mo) %>% 
  mutate(location = "missouri")
```


```{r nebraska-data}
path_ne <- "./data/deposition/Deposition data_NE.xlsx"

nebraska <- path_ne %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_ne", "upwind_ne", "inswath_ne")) %>% 
  map(readxl::read_excel, path = path_ne)



downwind_ne <- nebraska$downwind_ne %>% 
  mutate(type = "downwind")
upwind_ne <- nebraska$upwind_ne %>% 
  mutate('distance (m)' = NA,
         type = "upwind")
inswath_ne <- nebraska$inswath_ne %>%
  mutate('distance (m)' = NA,
         type = "inswath")

nebraska <- downwind_ne %>% 
  bind_rows(upwind_ne) %>% 
  bind_rows(inswath_ne) %>% 
  mutate(location = "nebraska")
```


```{r wisconsin-data}
path_wi <- "./data/deposition/Deposition data_WI.xlsx"

wisconsin <- path_wi %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_wi", "upwind_wi", "inswath_wi")) %>% 
  map(readxl::read_excel, path = path_wi)



downwind_wi <- wisconsin$downwind_wi %>% 
  mutate(type = "downwind")
upwind_wi <- wisconsin$upwind_wi %>% 
  mutate('distance (m)' = NA,
         type = "upwind")
inswath_wi <- wisconsin$inswath_wi %>%
  mutate('distance (m)' = NA,
         type = "inswath")

wisconsin <- downwind_wi %>% 
  bind_rows(upwind_wi) %>% 
  bind_rows(inswath_wi) %>% 
  mutate(location = "wisconsin")
```


```{r}
data <- missouri %>% 
  bind_rows(nebraska) %>% 
  bind_rows(wisconsin) %>% 
  janitor::clean_names() %>% 
  rename(deposition = n_l_cm2) %>% 
  mutate_if(is_character, as_factor) %>% 
  mutate(distance_m2 = distance_m - 1)
```


# Weather --------------------------------------------------------------------------------

```{r}
path_mo <- "./data/weather/Weather data_MO.xlsx"

missouri <- path_mo %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_mo", "upwind_mo", "inswath_mo")) %>% 
  map(readxl::read_excel, path = path_mo)

library(purrr)
file.list <- list.files(path="data/weather", pattern='*.xlsx')
file.list <- setNames(file.list, file.list) # only needed when you need an id-column with the file-names

df <- map_df(file.list, readxl::read_excel, .id = "id")
```

```{r message=FALSE}
data_path <- "./data/weather"   
files <- dir(data_path, pattern = '*.xlsx') 

weather_data <- files %>%
  map(~ readxl::read_excel(file.path(data_path, .)))
```


```{r message=FALSE, warning=FALSE}
weather_mo <- weather_data[[1]] %>% 
  janitor::row_to_names(row_number = 1)


weather_ne <- weather_data[[2]] %>% 
  janitor::row_to_names(row_number = 1)


weather_wi <- weather_data[[3]] %>% 
  janitor::row_to_names(row_number = 1)

weather <- weather_mo %>% 
  bind_rows(weather_ne) %>% 
  bind_rows(weather_wi) %>% 
  janitor::clean_names() %>% 
  mutate_at(vars(pass:wd_analysis), funs(round(3))) %>% 
  mutate(date = lubridate::mdy_hms(date))
```



```{r}
data %>% 
  distinct(pass, block, date, solution, sprayer, nozzle, type, pass, location)
```

```{r}
data1 %>% 
  filter(type == "downwind") %>%
  ggplot(aes(x = distance_m, y = deposition, color = trt)) +
  geom_jitter(alpha = 0.1) +
  facet_grid(~ location)
```


```{r}
data1 <- data %>% 
  unite("trt", c("sprayer", "nozzle"), sep = "_", remove = FALSE)
```


```{r}
data2 <- data1 %>% 
  filter(type == "downwind") %>% 
  group_by(location, solution) %>% 
  nest()
```


```{r drc-full}
drc_model <- function(df) {
  drm(deposition ~ distance_m, trt, fct = l3(), data = df)
}
```


```{r message=FALSE, warning=FALSE}
data3 <- data2 %>% 
  mutate(model = map(data, drc_model),
         summary = map(model, tidy))
```


```{r}
data3 %>% 
  unnest(summary)
```


```{r}
plot(data3$model[[4]], type = "all", log = "")
```


```{r}
data3 %>% 
  unnest(summary)
```


```{r message=FALSE, warning=FALSE}
data3 %>% 
  unnest(summary)
```




