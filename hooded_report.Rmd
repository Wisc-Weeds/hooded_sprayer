---
title: "Hooded sprayer studies in Missouri, Nebraska and Wisconsin"
author: "Maxwel Coura Oliveira, Guilherme Alves and Rodrigo Werle"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty: 
    theme: architect
    highlight: github
    toc: true
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center')
```

<center>
```{r echo=FALSE}
library(tweetrmd)
tweet_embed("https://twitter.com/i/status/1306184791042256897")
```
</center>


# Packages

```{r message = FALSE}
library(tidyverse)
library(lme4)
library(emmeans)
library(lmerTest)
library(patchwork)
options(scipen = 999)
```


# Deposition

## Load deposition dataset

```{r load-data}
#missouri
path_mo <- "./data/deposition/Deposition data_MO.xlsx"

missouri <- path_mo %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_mo", "upwind_mo", "inswath_mo")) %>% 
  map(readxl::read_excel, path = path_mo)



downwind_mo <- missouri$downwind_mo %>% 
  mutate(type = "downwind")
upwind_mo <- missouri$upwind_mo %>% 
  mutate('distance (m)' = NA,
         type = "upwind")
inswath_mo <- missouri$inswath_mo %>%
  mutate('distance (m)' = NA,
         type = "inswath") %>% 
  dplyr::select(-...8)

missouri <- downwind_mo %>% 
  bind_rows(upwind_mo) %>% 
  bind_rows(inswath_mo) %>% 
  mutate(location = "missouri")


#nebraska
path_ne <- "./data/deposition/Deposition data_NE.xlsx"

nebraska <- path_ne %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_ne", "upwind_ne", "inswath_ne")) %>% 
  map(readxl::read_excel, path = path_ne)



downwind_ne <- nebraska$downwind_ne %>% 
  mutate(type = "downwind")
upwind_ne <- nebraska$upwind_ne %>% 
  mutate('distance (m)' = NA,
         type = "upwind")
inswath_ne <- nebraska$inswath_ne %>%
  mutate('distance (m)' = NA,
         type = "inswath")

nebraska <- downwind_ne %>% 
  bind_rows(upwind_ne) %>% 
  bind_rows(inswath_ne) %>% 
  mutate(location = "nebraska")


#wisconsin
path_wi <- "./data/deposition/Deposition data_WI.xlsx"

wisconsin <- path_wi %>% 
  readxl::excel_sheets() %>% 
  set_names(c("downwind_wi", "upwind_wi", "inswath_wi")) %>% 
  map(readxl::read_excel, path = path_wi)



downwind_wi <- wisconsin$downwind_wi %>% 
  mutate(type = "downwind")
upwind_wi <- wisconsin$upwind_wi %>% 
  mutate('distance (m)' = NA,
         type = "upwind")
inswath_wi <- wisconsin$inswath_wi %>%
  mutate('distance (m)' = NA,
         type = "inswath")

wisconsin <- downwind_wi %>% 
  bind_rows(upwind_wi) %>% 
  bind_rows(inswath_wi) %>% 
  mutate(location = "wisconsin")
```

### Join location datasets

```{r join-data}
data <- missouri %>% 
  bind_rows(nebraska) %>% 
  bind_rows(wisconsin) %>% 
  janitor::clean_names() %>% 
  rename(deposition = n_l_cm2) %>% 
  mutate_if(is_character, as_factor) %>% 
  mutate(block = as_factor(block)) %>% 
  mutate(distance_m = replace_na(distance_m, 0)) %>% 
  mutate(distance_log = log10(distance_m),
         deposition_log = log10(deposition)) 
```

```{r}
data 
```


## Deposition inswath ------------------------------------------------------

### Filter deposition dataset inswath

```{r}
inswath <-  data %>% 
  filter(type == "inswath")
```

### Test ANOVA assumptions

#### Normal distribution

```{r}
inswath %>% 
  ggplot(aes(x = deposition)) +
  geom_histogram()
# data has normal distribution
```

#### Homogeneity of variances

```{r}
bartlett.test(deposition ~ location, data = inswath)
# can't compare locations
```


### Data analysis

#### Filter location

```{r}
# nebraska and wisconsin 
inswath1 <- inswath %>% 
  group_by(location) %>% 
  nest() %>% 
  filter(location != "missouri")
```

#### Model

```{r}
model <- function(df){
  lmer(deposition ~ solution * sprayer * nozzle + (1|block), 
              REML = FALSE, data = df)
}
```

#### Fit models and ANOVA

```{r}
inswath2 <- inswath1 %>% 
  mutate(model = map(data, model),
         anova = map(model, anova))
```



### Nebraska

```{r}
model_ne <- inswath2$model[[1]]
# anova
anova(model_ne)
```

#### Solution x sprayer 

```{r}
lsmeans_ne1 <- emmeans(model_ne, ~ solution * sprayer, cont="pairwise", 
                      adjust="none", alpha=0.05)

lsmeans_ne1
```

##### Plot

```{r}
plot(lsmeans_ne1$emmeans, ~ solution * sprayer, comparisons=TRUE, 
     alpha=0.05, adjust="none") +
  labs(title = "Nebraska (Solution vs Sprayer)")
```


#### Solution x nozzle 

```{r}
lsmeans_ne2 <- emmeans(model_ne, ~ solution * nozzle, cont="pairwise", 
                      adjust="none", alpha=0.05)

lsmeans_ne2
```

##### Plot

```{r}
plot(lsmeans_ne2$emmeans, ~ solution * sprayer, comparisons=TRUE, 
     alpha=0.05, adjust="none") +
  labs(title = "Nebraska (Solution vs Nozzle)")
```



### Wisconsin

```{r}
model_wi <- inswath2$model[[2]]

#anova
anova(model_wi)
```


#### Solution x nozzle by sprayer

```{r}
lsmeans_wi <- emmeans(model_wi, ~ solution * nozzle | sprayer, cont="pairwise", 
                      adjust="none", alpha=0.05)
```
##### Plot 

```{r}
plot(lsmeans_wi$emmeans, ~ solution * nozzle | sprayer, comparisons=TRUE, 
     alpha=0.05, adjust="none") +
  labs(title = "Wisconsin (Solution x nozzle by sprayer")
```


### Missouri 

```{r}
data_missou <- inswath %>% 
  filter(location == "missouri")

#missou model has no solution levels
model_mo <- lmer(deposition ~ sprayer * nozzle + (1|block), 
              REML = FALSE, data = data_missou)

#anova
anova(model_mo)
```

#### Sprayer

```{r}
lsmeans_mo <- emmeans(model_mo, ~ sprayer, cont="pairwise", adjust="none", alpha=0.05)

lsmeans_mo
```

##### Plot

```{r}
plot(lsmeans_mo$emmeans, ~ herbicide, comparisons=TRUE, alpha=0.05, adjust="none") +
 labs(title = "Missouri (sprayer)")
```


## Deposition upwind ------------------------------------------------------

### Filter deposition dataset upwind

```{r}
upwind <- data %>% 
  filter(type == "upwind")
```

### Test ANOVA assumptions

#### Normal distribution

```{r}
upwind %>% 
  ggplot(aes(x = deposition)) +
  geom_histogram() 
# not normalized
```

##### Log scale

```{r}
upwind %>% 
  ggplot(aes(x = log(deposition))) +
  geom_histogram()
# yes!
```

#### Homogeneity of variances

```{r}
bartlett.test(deposition ~ location, data = upwind)
# can't compare locations
```


### Nebraska

#### Filter upwind Nebraska

```{r}
ne_data <- upwind %>% 
  filter(location == "nebraska")
```

#### Model

```{r}
ne_model <- lmer(log(deposition) ~ solution * sprayer * nozzle + (1|block), 
              REML = FALSE, data = ne_data)
```

#### ANOVA 

```{r}
anova(ne_model)
```

#### Solution

```{r}
ne_lsmeans <- emmeans(ne_model, ~ solution, cont="pairwise", type = "response",
                      adjust="none", alpha=0.05)

ne_lsmeans
```

#### Plot

```{r}
plot(ne_lsmeans$emmeans, ~ solution, comparisons=TRUE, alpha=0.05, type = "response",
     adjust="none") +
 labs(title = "Nebraska (Solution)")
```

### Missouri

#### Filter upwind Missouri

```{r}
mo_data <- upwind %>% 
  filter(location == "missouri")
```

#### Model

```{r}
mo_model <- lmer(log(deposition) ~ sprayer * nozzle + (1|block), 
              REML = FALSE, data = mo_data)
```

#### ANOVA

```{r}
anova(mo_model)
```

### Wisconsin

#### Filter upwind Wisconsin

```{r}
wi_data <- upwind %>% 
  filter(location == "wisconsin")
```

#### Model

```{r}
wi_model <- lmer(log(deposition) ~ solution * sprayer * nozzle + (1|block), 
              REML = FALSE, data = wi_data)
```

#### ANOVA

```{r}
anova(wi_model)
```

```{r}
wi_lsmeans <- emmeans(wi_model, ~ solution, cont="pairwise", type = "response",
                      adjust="none", alpha=0.05)

wi_lsmeans
```

#### Plot

```{r}
plot(wi_lsmeans$emmeans, ~ solution, comparisons=TRUE, alpha=0.05, type = "response",
     adjust="none") +
 labs(title = "Wisconsin (Solution)")
```

## Deposition downwind ------------------------------------------------------

### Filter deposition dataset downwind

```{r}
data_dw <- data %>% 
  filter(type == "downwind")
```

```{r}
data_dw %>% 
  group_by(location, solution, sprayer, nozzle, distance_m) %>% 
  summarise(mean_deposition = mean(deposition),
            mean_deposition_log = log(mean_deposition)) %>% 
  filter(distance_m == "1") %>% 
  filter(location == "wisconsin")
```


### Visualize

```{r}
data_dw %>% 
  ggplot(aes(x = distance_m, y = deposition, color = nozzle)) +
  geom_point() +
  facet_grid(~ location)
# some trt have rapid decrease and some trt have linear trend
```


### Visualize (log scale)


```{r}
data_dw %>% 
  filter(location == "wisconsin") %>% 
  ggplot(aes(x = log(distance_m), y = log(deposition), color = nozzle)) +
  geom_point() +
  facet_grid(sprayer ~ solution) +
  geom_smooth(method = "lm") 
# better go with log scale
```

### Normal distribution

```{r}
data_dw %>% 
  ggplot(aes(x = log(deposition))) +
  geom_histogram() +
  facet_grid(~location)
```

### Arrange dataset

```{r}
data_dw1 <- data_dw %>% 
  group_by(location, solution, sprayer, nozzle) %>% 
  nest()

data_dw1
```

### Model function

```{r}
model <- function(df){
  lmer(log(deposition) ~ log(distance_m) + 
         (1|block), REML = FALSE, data = df)
}
```

### Fit model and confidence intervals

```{r warning=FALSE, message = FALSE}
data_dw2 <- data_dw1 %>% 
  mutate(model = map(data, model),
         summary = map(model, broom.mixed::tidy),
         confint = map(model, confint))
```

### Get parameters from models

```{r}
params <- data_dw2 %>% 
  unnest(summary) %>% 
  filter(effect == "fixed") %>% 
  mutate(estimate_exp = exp(estimate),
         estimate_exp = case_when(
           term == "log(distance_m)" ~ -estimate_exp,
           TRUE                      ~ estimate_exp
         )) %>% 
  dplyr::select(location, solution, sprayer, nozzle, term, estimate, std.error, statistic, p.value, estimate_exp) %>% 
  mutate(p.value = round(p.value, 3)) %>% 
  mutate(term = fct_recode(term,
                           slope = "log(distance_m)"),
         term = fct_recode(term,
                           Intercept = "(Intercept)")) %>% 
  unite("trt", c("solution", "sprayer", "nozzle"), sep = " ", remove = FALSE)

params
```

### Get confidence intervals

```{r}
get_cis <- function(number){
  exp(data_dw2$confint[[number]]) %>%
    as_tibble() %>%
    slice_tail(n=2)
} 

number <- as_tibble(c(1:30))

intervals <- number %>%
  mutate(interval = map(value, get_cis)) %>%
  unnest(interval)

# join to main dataset
downwind_final <- params %>%
  bind_cols(intervals) %>%
  rename(lower = `2.5 %`,
         upper = `97.5 %`) %>%
  mutate(lower = case_when(
           term == "log(distance_m)" ~ -lower,
         TRUE                        ~ lower
         ),
         upper = case_when(
           term == "log(distance_m)" ~ -upper,
         TRUE                        ~ upper,
         )) %>% 
  mutate(across(where(is_double), round, 3))
```


## Distance of deposition at 0

```{r}
distance_final <- downwind_final %>% 
  dplyr::select(trt, term, estimate_exp) %>% 
  pivot_wider(
              names_from = term, 
              values_from = estimate_exp) 
```


```{r}
distance_function <- function(int, slope, y = 0) {
  distance = (y - int) / slope
  return(distance)
}

distance_final1 <- distance_final %>% 
  mutate(distance_m = map2_dbl(Intercept, slope, distance_function),
         distance_m = round(distance_m, 10)) 
```

## Predict


```{r}
linear <- function(a, b, d) {
  y = a + b*d
  return(y)
}

linear(distance_final1$Intercept, distance_final1$slope, distance_final1$distance_m)
```



```{r}
nd <- tibble(distance_m = seq(log(1:60), by = 0.1))

predict(data_dw2$model[[1]], newdata = nd, re.form= NA, interval = "prediction") 
```



```{r}

data_dw2 %>% 
  left_join(distance_final1) %>% 
  mutate(fit = map2_dbl(model, distance_m, ~predict))

augment(data_dw2$model[[1]], 
            new_data = distance_final1, 
             type = "conf_int")
```


```{r}
data_dw2 %>% 
  left_join(distance_final1) %>% 
  mutate(fit = map2(model, distance_m, predict, type = 'conf_int'))
```


### Figure 

```{r fig.height=8, fig.width==6} 
downwind_final %>%
  ggplot(aes(x = trt, y = estimate_exp, color = trt)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  facet_grid(location ~ term, scales = "free") +
  coord_flip() + 
  scale_color_brewer(palette = "Paired") + 
  labs(y = expression(paste("Estimates (ƞL/cm"^"2",")")), x = "") + 
  theme_bw() + 
  theme(legend.position = "none") 
``` 


```{r}
downwind_final1 <- downwind_final %>% 
  pivot_wider(id_cols = location:nozzle,
              names_from = term, 
              values_from = estimate_exp) 
```


```{r}
a <- downwind_final %>% 
  filter(term == "Intercept") %>% 
  filter(location == "wisconsin") %>% 
  ggplot(aes(x = reorder(trt, estimate_exp), y = estimate_exp, color = trt)) +
  geom_point(size = 2, stroke = 1) +
  scale_color_brewer(palette = "Paired") +
  geom_linerange(aes(ymin = lower, ymax = upper), size = 1.5) +
  coord_flip() +
  labs(title = "Intercept", 
       y = expression(paste("Estimates (ƞL/cm"^"2",")")), x = "") +
  theme_bw() +
  theme(legend.position = "none")

b <- downwind_final %>% 
  filter(term == "slope") %>% 
  filter(location == "wisconsin") %>% 
  ggplot(aes(x = reorder(trt, estimate_exp), y = estimate_exp, color = trt)) +
  geom_point(size = 2, stroke = 1) +
  scale_color_brewer(palette = "Paired") +
  geom_linerange(aes(ymin = -lower, ymax = -upper), size = 1.5) +
  coord_flip() +
  labs(title = "Slope", 
       y = expression(paste("Estimates (ƞL/cm"^"2",")")), x = "") +
  theme_bw() +
  theme(legend.position = "none")

c <- distance_final1 %>% 
  filter(location == "wisconsin") %>% 
  ggplot(aes(x = reorder(trt, distance_m), 
             y = distance_m,
             label = distance_m, fill = trt)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_brewer(palette = "Paired") +
  labs(title = "0 deposition", 
       y = "distance (m)", x = "") +
#  geom_label(aes(label = distance_0)) +
  ylim(0,115) +
  theme_bw() +
  theme(legend.position = "none") 


library(patchwork)

p <- a | b | c
  ggsave("wisconsin.png", p, width = 9, height = 3)

```












```{r}
data_dw2 %>% 
  left_join(distance_final1) %>% 
  mutate(`log(distance_m)` = log(distance_0)) %>% 
  mutate(predict = map2_dbl(model, `log(distance_m)`, ~predict))
```

```{r}
data_dw2$model
```


```{r}
distance_final1 %>% 
  ggplot(aes(x = fct_reorder(trt, distance_0), 
             y = distance_0,
             label = distance_0)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_color_brewer(palette = "Paired") +
  labs(title = "Estimated distance where no herbicide solution deposition is predicted", 
       y = "distance (m)", x = "") +
  geom_label(aes(label = distance_0)) +
  ylim(0,115) +
  facet_grid(~ location) +
  theme_bw() +
  theme(legend.position = "none") +
  ggsave("distance.pdf", height = 5, width = 8)
```





```{r}
downwind_final %>% 
  filter(location == "wisconsin" & term == "log(distance_m)") %>% 
  ggplot(aes(x = fct_reorder(trt, estimate_exp), y = estimate_exp)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
   coord_flip() +
  scale_color_brewer(palette = "Paired") +
  labs(y = expression(paste("Estimates (ƞL/cm"^"2",")")), x = "") +
  theme_bw() +
  theme(legend.position = "none") 
```







### Final downwind dataset 

```{r}
downwind_final %>% 
  DT::datatable()
```


# Weather ----------------------------------------------------------------------

## Read weather dataset

```{r message=FALSE}
data_path <- "./data/weather"   
files <- dir(data_path, pattern = '*.xlsx') 

weather_data <- files %>%
  map(~ readxl::read_excel(file.path(data_path, .)))

weather_mo <- weather_data[[1]] %>% 
  janitor::row_to_names(row_number = 1)


weather_ne <- weather_data[[2]] %>% 
  janitor::row_to_names(row_number = 1)


weather_wi <- weather_data[[3]] %>% 
  janitor::row_to_names(row_number = 1)
```

## Tidy weather dataset

```{r message=FALSE}
weather <- weather_mo %>% 
  bind_rows(weather_ne) %>% 
  bind_rows(weather_wi) %>% 
  janitor::clean_names() %>% 
  mutate(date = lubridate::mdy_hms(date)) %>% 
  mutate_at(vars(pass:wind_speed_average_19), funs(as.double),
            vars(pass:wind_speed_average_19), funs(round(.,5))) %>% 
  rename_at(vars(wind_direction_max_9:wind_speed_average_13), paste0, "_voltage") %>% 
  rename_at(vars(wind_direction_min_14:wind_direction_average_16), paste0, "_degress") %>% 
  rename_at(vars(wind_speed_min_17:wind_speed_average_19), paste0, "_mph") %>% 
  filter(!is.na(pass))
```

